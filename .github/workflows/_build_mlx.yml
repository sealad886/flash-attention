name: ~Build MLX wheel template

on:
  workflow_call:
    inputs:
      runs-on:
        description: "The runner to use for the build"
        required: true
        type: string
        default: macos-14
      python-version:
        description: "The Python version to use for the build"
        required: true
        type: string
      upload-to-release:
        description: "Upload wheel to this release"
        required: false
        type: boolean
        default: false
      release-version:
        description: "Upload wheel to this release"
        required: false
        type: string

defaults:
  run:
    shell: bash -x -e -u -o pipefail {0}

jobs:
  build-mlx-wheel:
    runs-on: ${{ inputs.runs-on }}
    name: Build MLX wheel (${{ inputs.release-version }}-${{ inputs.python-version }}-mlx)

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.release-version }}
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Set environment variables
        run: |
          echo "MATRIX_PYTHON_VERSION=$(echo ${{ inputs.python-version }} | awk -F \. {'print $1 $2'})" >> $GITHUB_ENV

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools>=75.8.0 wheel build
          pip install mlx numpy einops

      - name: Build MLX wheel
        run: |
          # Skip CUDA build, only build the Python package with MLX backend
          export FLASH_ATTENTION_SKIP_CUDA_BUILD="TRUE"

          python -m build --wheel --outdir dist/

          # Rename wheel to indicate MLX backend
          for wheel in dist/*.whl; do
            if [ -f "$wheel" ]; then
              newname=$(basename "$wheel" | sed "s/-py3/-mlx-py3/")
              mv "$wheel" "dist/${newname}"
              echo "wheel_name=${newname}" >> $GITHUB_ENV
            fi
          done

      - name: Verify wheel
        run: |
          pip install dist/*.whl
          python -c "from flash_attn.flash_attn_mlx import flash_attn_func; print('MLX backend import successful')"
          python -c "from flash_attn.flash_attn_mlx import is_mlx_available; print('MLX available:', is_mlx_available())"

      - name: Log Built Wheels
        run: |
          ls -la dist/

      - name: Get Release with tag
        if: inputs.upload-to-release
        id: get_current_release
        uses: joutvhu/get-release@v1
        with:
          tag_name: ${{ inputs.release-version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Release Asset
        id: upload_release_asset
        if: inputs.upload-to-release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.get_current_release.outputs.upload_url }}
          asset_path: ./dist/${{ env.wheel_name }}
          asset_name: ${{ env.wheel_name }}
          asset_content_type: application/*

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: mlx-wheel-${{ inputs.python-version }}
          path: dist/*.whl
          retention-days: 5
