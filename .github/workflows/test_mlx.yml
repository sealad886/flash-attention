name: Test MLX Backend

on:
  pull_request:
    paths:
      - 'flash_attn/flash_attn_mlx/**'
      - 'tests/**/test*mlx*'
      - 'benchmarks/**/benchmark*mlx*'
      - '.github/workflows/test_mlx.yml'
  push:
    branches:
      - main
    paths:
      - 'flash_attn/flash_attn_mlx/**'
      - 'tests/**/test*mlx*'
      - 'benchmarks/**/benchmark*mlx*'
      - '.github/workflows/test_mlx.yml'
  workflow_dispatch:

# NOTE: GitHub-hosted macOS runners are virtualized and do NOT have Metal GPU access.
# MLX requires Metal, so full MLX testing requires self-hosted Apple Silicon runners.
# This workflow tests import/syntax only on GitHub-hosted runners.
# For full GPU tests, use self-hosted runners with label 'self-hosted-apple-silicon'.

jobs:
  # Basic syntax and import tests on GitHub-hosted runner (no Metal GPU)
  test-mlx-imports:
    runs-on: macos-26
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    name: Test MLX Imports (Python ${{ matrix.python-version }})

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest numpy einops
          # Note: Skip MLX installation on GitHub runners - it requires Metal GPU
          # MLX import will fail gracefully in our code when not available
          FLASH_ATTENTION_SKIP_CUDA_BUILD=TRUE pip install -e .

      - name: Verify flash-attn package structure (no MLX execution)
        run: |
          # Verify the package installed correctly
          python -c "import flash_attn; print('flash-attn version:', flash_attn.__version__)"
          
          # Validate MLX backend Python syntax without importing MLX
          python -c "
          import sys
          import ast
          import os
          
          print('Validating MLX backend Python files syntax...')
          
          mlx_dir = 'flash_attn/flash_attn_mlx'
          if not os.path.exists(mlx_dir):
              print(f'✗ MLX directory not found: {mlx_dir}')
              sys.exit(1)
          
          errors = []
          file_count = 0
          
          for root, dirs, files in os.walk(mlx_dir):
              for file in files:
                  if file.endswith('.py'):
                      filepath = os.path.join(root, file)
                      file_count += 1
                      try:
                          with open(filepath, 'r') as f:
                              ast.parse(f.read())
                          print(f'  ✓ {filepath}')
                      except SyntaxError as e:
                          errors.append(f'{filepath}: {e}')
                          print(f'  ✗ {filepath}: {e}')
          
          if errors:
              print(f'\n❌ {len(errors)} syntax error(s) found!')
              for err in errors:
                  print(f'  - {err}')
              sys.exit(1)
          else:
              print(f'\n✅ All {file_count} MLX backend files have valid Python syntax!')
          "
          
          echo ""
          echo "Note: MLX library itself not installed (requires Metal GPU not available in VMs)"
          echo "Full MLX testing requires self-hosted Apple Silicon runners"

      - name: Validate test files syntax
        run: |
          # Validate test files syntax without running them
          python -c "
          import sys
          import ast
          import os
          
          print('Validating MLX test files syntax...')
          
          test_patterns = [
              'flash_attn/flash_attn_mlx/tests/',
              'tests/',
              'benchmarks/'
          ]
          
          errors = []
          file_count = 0
          
          for pattern in test_patterns:
              if not os.path.exists(pattern):
                  continue
                  
              for root, dirs, files in os.walk(pattern):
                  for file in files:
                      if 'mlx' in file.lower() and file.endswith('.py'):
                          filepath = os.path.join(root, file)
                          file_count += 1
                          try:
                              with open(filepath, 'r') as f:
                                  ast.parse(f.read())
                              print(f'  ✓ {filepath}')
                          except SyntaxError as e:
                              errors.append(f'{filepath}: {e}')
                              print(f'  ✗ {filepath}: {e}')
          
          if errors:
              print(f'\n❌ {len(errors)} syntax error(s) in test files!')
              for err in errors:
                  print(f'  - {err}')
              sys.exit(1)
          elif file_count > 0:
              print(f'\n✅ All {file_count} MLX test files have valid Python syntax!')
          else:
              print('\n⚠️  No MLX test files found')
          "

  # Full GPU tests - only runs on self-hosted Apple Silicon runners
  # Uncomment and configure when you have self-hosted runners available
  # test-mlx-gpu:
  #   runs-on: [self-hosted, macOS, ARM64, apple-silicon]
  #   name: Test MLX GPU (Self-hosted)
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v5
  #     - name: Set up Python
  #       run: |
  #         python3 -m pip install --upgrade pip
  #         pip3 install pytest pytest-xdist numpy einops mlx
  #         FLASH_ATTENTION_SKIP_CUDA_BUILD=TRUE pip3 install -e .
  #     - name: Verify Metal GPU access
  #       run: |
  #         python3 -c "from flash_attn.flash_attn_mlx import is_mlx_available, get_gpu_family; print('MLX:', is_mlx_available(), 'GPU:', get_gpu_family())"
  #     - name: Run full MLX test suite
  #       run: |
  #         pytest flash_attn/flash_attn_mlx/tests/ -v --tb=short

  benchmark-mlx:
    runs-on: macos-14
    needs: test-mlx-imports
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    name: Benchmark MLX (Import Check Only)

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest numpy einops tabulate
          FLASH_ATTENTION_SKIP_CUDA_BUILD=TRUE pip install -e .

      - name: Validate benchmark scripts
        run: |
          echo "NOTE: Full MLX benchmarks require Metal GPU access."
          echo "GitHub-hosted runners are virtualized and don't have Metal."
          echo "For real benchmarks, run locally on Apple Silicon or use self-hosted runners."
          echo ""
          echo "Validating benchmark script syntax..."
          
          if [ -f benchmarks/benchmark_flash_attn_mlx.py ]; then
            python -c "import ast; ast.parse(open('benchmarks/benchmark_flash_attn_mlx.py').read()); print('✓ Benchmark script syntax OK')"
          else
            echo "⚠️  MLX benchmark file not found, skipping"
          fi
